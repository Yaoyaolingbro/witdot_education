# 🚀 witdot Education AI Platform - 快速部署指南

## 📋 部署前准备

### 1. 服务器要求
- **操作系统**: CentOS 7/8 或 RHEL 7/8
- **配置**: 最低 2核4GB，推荐 4核8GB
- **网络**: 需要公网 IP 地址
- **权限**: root 用户或具有 sudo 权限

### 2. 开放安全组端口

**重要**: 在运行部署脚本前，必须先开放以下端口：

#### 阿里云 ECS 安全组设置
1. 登录阿里云控制台
2. 进入 **云服务器 ECS** → **实例**
3. 选择你的服务器实例
4. 点击 **更多** → **网络和安全组** → **安全组配置**
5. 点击 **配置规则**
6. 添加以下入方向规则：

| 端口范围 | 授权对象 | 说明 |
|---------|---------|------|
| 80/80 | 0.0.0.0/0 | HTTP（必须） |
| 22/22 | 0.0.0.0/0 | SSH（已有） |

**注意**: 如果后续需要 HTTPS，还需要开放 443 端口。

#### 腾讯云/其他云服务商
类似步骤，在安全组或防火墙规则中开放 80 端口。

---

## 🎯 一键部署步骤

### 1. 连接到服务器
```bash
ssh root@47.96.174.6
```

### 2. 进入项目目录
```bash
cd /mnt/sda2/code/edu_app
```

### 3. 运行部署脚本
```bash
sudo ./deploy.sh
```

### 4. 按照提示操作

#### 步骤1：IP 地址选择
脚本会自动检测：
- **内网 IP**: 172.26.43.219（仅内网访问）
- **公网 IP**: 47.96.174.6（公网可访问）

```
请选择要使用的 IP 地址 [1=公网IP, 2=内网IP, 3=手动输入] (默认: 1):
```
**推荐**: 直接按 Enter 使用公网 IP

#### 步骤2：后端配置
```
请输入后端服务端口 [默认: 3210]:
```
**推荐**: 直接按 Enter 使用默认端口

```
请输入 MongoDB 数据库名 [默认: edu_app_prod]:
```
**推荐**: 直接按 Enter 使用默认数据库名

```
请输入 JWT Secret (留空将自动生成):
```
**推荐**: 直接按 Enter 自动生成安全密钥

#### 步骤3：API Key 配置
```
请输入 Claude API Key:
```
**必须输入**: 你的 Claude API Key（格式：sk-ant-api03-xxxxx）

### 5. 等待自动部署完成

脚本会自动执行以下操作：
- ✅ 安装 Node.js 18、MongoDB 6、Nginx、PM2
- ✅ 配置环境变量
- ✅ 安装项目依赖
- ✅ 构建前端代码
- ✅ 初始化数据库
- ✅ 配置 Nginx 反向代理
- ✅ 启动后端服务（PM2）
- ✅ 配置防火墙

**预计时间**: 5-15 分钟（取决于网络速度）

---

## 🎉 部署完成

部署成功后，你会看到如下信息：

```
============================================
[SUCCESS] 部署完成！
============================================

访问地址:
  前端页面: http://47.96.174.6
  后端 API: http://47.96.174.6/api

提示:
  - 请确保服务器安全组/防火墙已开放 80 端口
  - 如果无法访问，请检查云服务商的安全组设置
```

### 访问应用
在浏览器中打开：**http://47.96.174.6**

---

## 📊 服务管理命令

### 查看服务状态
```bash
# 查看后端服务状态
pm2 status

# 查看 Nginx 状态
systemctl status nginx

# 查看 MongoDB 状态
systemctl status mongod
```

### 查看日志
```bash
# 查看后端实时日志
pm2 logs eduapp-server

# 查看 Nginx 访问日志
tail -f /var/log/nginx/eduapp-access.log

# 查看 Nginx 错误日志
tail -f /var/log/nginx/eduapp-error.log
```

### 重启服务
```bash
# 重启后端服务
pm2 restart eduapp-server

# 重启 Nginx
systemctl restart nginx

# 重启 MongoDB
systemctl restart mongod
```

### 停止服务
```bash
# 停止后端服务
pm2 stop eduapp-server

# 停止 Nginx
systemctl stop nginx
```

---

## 🔧 故障排查

### 问题1: 无法访问网站

#### 检查步骤：
```bash
# 1. 检查后端是否运行
pm2 status

# 2. 检查 Nginx 是否运行
systemctl status nginx

# 3. 检查端口监听
netstat -tuln | grep -E '80|3210'

# 4. 检查防火墙
firewall-cmd --list-all
```

#### 常见原因：
- ❌ 云服务器安全组未开放 80 端口 → **去云控制台开放**
- ❌ 系统防火墙阻止 → `firewall-cmd --permanent --add-service=http && firewall-cmd --reload`
- ❌ Nginx 配置错误 → `nginx -t` 查看错误
- ❌ 后端服务未启动 → `pm2 restart eduapp-server`

### 问题2: API 请求失败

#### 检查步骤：
```bash
# 1. 测试后端 API
curl http://localhost:3210/api/health

# 2. 查看后端日志
pm2 logs eduapp-server --lines 50

# 3. 查看 Nginx 代理日志
tail -f /var/log/nginx/eduapp-error.log
```

#### 常见原因：
- ❌ MongoDB 未启动 → `systemctl start mongod`
- ❌ 环境变量配置错误 → 检查 `/mnt/sda2/code/edu_app/server/.env`
- ❌ Claude API Key 无效 → 更新 `.env` 文件中的 `ANTHROPIC_API_KEY`

### 问题3: 前端显示但 API 不通

#### 检查 Nginx 配置：
```bash
# 查看 Nginx 配置
cat /etc/nginx/conf.d/eduapp.conf

# 测试配置
nginx -t

# 重启 Nginx
systemctl restart nginx
```

---

## 🔄 更新部署

### 方法1：使用 Git 拉取更新
```bash
cd /mnt/sda2/code/edu_app

# 拉取最新代码
git pull origin main

# 重新构建前端
cd client
npm install
npm run build

# 重启后端
pm2 restart eduapp-server
```

### 方法2：重新运行部署脚本
```bash
cd /mnt/sda2/code/edu_app
sudo ./deploy.sh
```
**注意**: 会覆盖 `.env` 文件，请先备份配置。

---

## 📝 配置文件位置

| 文件 | 路径 | 说明 |
|------|------|------|
| 后端环境变量 | `/mnt/sda2/code/edu_app/server/.env` | API Key、数据库连接等 |
| 前端环境变量 | `/mnt/sda2/code/edu_app/client/.env.production` | API 地址配置 |
| Nginx 配置 | `/etc/nginx/conf.d/eduapp.conf` | Web 服务器配置 |
| PM2 配置 | `~/.pm2/` | 进程管理配置 |

---

## 🔐 安全建议

### 1. 修改 MongoDB 认证
```bash
mongosh
use admin
db.createUser({
  user: "admin",
  pwd: "强密码",
  roles: [ { role: "userAdminAnyDatabase", db: "admin" } ]
})
exit
```

### 2. 配置 HTTPS（可选但推荐）
使用 Let's Encrypt 免费证书：
```bash
# 安装 certbot
yum install -y certbot python3-certbot-nginx

# 获取证书（需要域名）
certbot --nginx -d yourdomain.com
```

### 3. 限制 SSH 访问
```bash
# 只允许密钥登录，禁止密码登录
nano /etc/ssh/sshd_config
# 修改: PasswordAuthentication no

systemctl restart sshd
```

---

## 📞 获取帮助

### 常用资源
- [完整部署教程](./部署教程.md)
- [项目 README](../README.md)
- [开发计划](./开发计划.md)

### 问题反馈
如果遇到问题，请检查：
1. 日志文件（`pm2 logs` 和 `/var/log/nginx/`）
2. 配置文件是否正确
3. 安全组和防火墙设置

---

**文档版本**: v1.0
**最后更新**: 2025-10-29
**适用系统**: CentOS 7/8, RHEL 7/8
