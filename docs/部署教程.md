# 🚀 witdot Education AI Platform - 生产环境部署教程

本文档提供在服务器 **47.96.174.6** 上部署 witdot Education AI Platform 的完整指南。

## 📋 目录

- [环境要求](#环境要求)
- [服务器准备](#服务器准备)
- [安装依赖](#安装依赖)
- [部署步骤](#部署步骤)
- [Nginx 配置](#nginx-配置)
- [PM2 进程管理](#pm2-进程管理)
- [SSL证书配置](#ssl证书配置)
- [监控和维护](#监控和维护)
- [常见问题](#常见问题)

---

## 🔧 环境要求

### 最低配置
- **CPU**: 2核
- **内存**: 4GB
- **磁盘**: 20GB 可用空间
- **操作系统**: Ubuntu 20.04+ / CentOS 7+
- **网络**: 公网IP，开放端口 80、443

### 软件要求
- Node.js 18.x 或更高版本
- MongoDB 6.x
- Nginx 1.18+
- PM2（进程管理）
- Git

---

## 🖥 服务器准备

### 1. 连接到服务器

```bash
ssh root@47.96.174.6
```

### 2. 更新系统

```bash
# Ubuntu/Debian
sudo apt update && sudo apt upgrade -y

# CentOS/RHEL
sudo yum update -y
```

### 3. 创建应用用户（可选但推荐）

```bash
# 创建专用用户
sudo adduser eduapp
sudo usermod -aG sudo eduapp

# 切换到应用用户
su - eduapp
```

---

## 📦 安装依赖

### 1. 安装 Node.js 18.x

```bash
# 使用 NodeSource 仓库
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt install -y nodejs

# 验证安装
node --version  # 应显示 v18.x.x
npm --version   # 应显示 9.x.x
```

### 2. 安装 MongoDB 6.x

```bash
# 导入 MongoDB GPG 公钥
wget -qO - https://www.mongodb.org/static/pgp/server-6.0.asc | sudo apt-key add -

# 添加 MongoDB 仓库
echo "deb [ arch=amd64,arm64 ] https://repo.mongodb.org/apt/ubuntu focal/mongodb-org/6.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-6.0.list

# 安装 MongoDB
sudo apt update
sudo apt install -y mongodb-org

# 启动 MongoDB 服务
sudo systemctl start mongod
sudo systemctl enable mongod

# 验证安装
sudo systemctl status mongod
mongosh --version
```

### 3. 安装 Nginx

```bash
sudo apt install -y nginx

# 启动 Nginx
sudo systemctl start nginx
sudo systemctl enable nginx

# 验证安装
nginx -v
```

### 4. 安装 PM2（Node.js 进程管理器）

```bash
sudo npm install -g pm2

# 验证安装
pm2 --version
```

### 5. 安装 Git

```bash
sudo apt install -y git

# 验证安装
git --version
```

---

## 🚀 部署步骤

### 1. 克隆项目代码

```bash
# 进入应用目录
cd /var/www

# 克隆代码（替换为你的仓库地址）
sudo git clone <your-repository-url> eduapp
sudo chown -R $USER:$USER eduapp
cd eduapp
```

### 2. 配置环境变量

#### 后端环境变量

```bash
cd /var/www/eduapp/server
cp .env.example .env
nano .env
```

编辑 `.env` 文件，配置生产环境参数：

```env
# 服务器配置
PORT=3210
NODE_ENV=production
HOST=0.0.0.0

# MongoDB 配置
MONGODB_URI=mongodb://localhost:27017/edu_app_prod

# JWT 配置
JWT_SECRET=your-production-secret-key-change-this-to-random-string
JWT_EXPIRES_IN=7d

# Claude API 配置
ANTHROPIC_API_KEY=sk-ant-your-api-key-here

# CORS 配置
CORS_ORIGIN=https://your-domain.com

# 日志配置
LOG_LEVEL=info
```

#### 前端环境变量

```bash
cd /var/www/eduapp/client
nano .env.production
```

创建生产环境配置：

```env
# API 基础地址
VITE_API_URL=https://your-domain.com/api

# 或使用 IP 地址
# VITE_API_URL=http://47.96.174.6:3210/api
```

### 3. 安装依赖

```bash
# 安装后端依赖
cd /var/www/eduapp/server
npm install --production

# 安装前端依赖并构建
cd /var/www/eduapp/client
npm install
npm run build
```

### 4. 初始化数据库

```bash
cd /var/www/eduapp/server

# 运行课程同步脚本
node src/scripts/syncCourses.js
```

### 5. 启动后端服务（使用 PM2）

```bash
cd /var/www/eduapp/server

# 使用 PM2 启动应用
pm2 start src/app.js --name "eduapp-server" --watch

# 查看运行状态
pm2 status

# 查看日志
pm2 logs eduapp-server
```

### 6. 配置 PM2 开机自启

```bash
# 保存 PM2 进程列表
pm2 save

# 生成开机启动脚本
pm2 startup

# 按照提示执行命令（通常是一条 sudo 命令）
```

---

## ⚙️ Nginx 配置

### 1. 创建 Nginx 配置文件

```bash
sudo nano /etc/nginx/sites-available/eduapp
```

### 2. 基础配置（HTTP）

```nginx
server {
    listen 80;
    server_name 47.96.174.6 your-domain.com;

    # 前端静态文件
    root /var/www/eduapp/client/dist;
    index index.html;

    # 日志配置
    access_log /var/log/nginx/eduapp-access.log;
    error_log /var/log/nginx/eduapp-error.log;

    # Gzip 压缩
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
    gzip_comp_level 6;

    # 前端路由
    location / {
        try_files $uri $uri/ /index.html;
    }

    # 后端 API 代理
    location /api {
        proxy_pass http://localhost:3210;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;

        # 超时配置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # 静态资源（课程文件等）
    location /public {
        alias /var/www/eduapp/server/public;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # 缓存静态资源
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
```

### 3. 启用配置并重启 Nginx

```bash
# 创建符号链接
sudo ln -s /etc/nginx/sites-available/eduapp /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重启 Nginx
sudo systemctl restart nginx

# 查看状态
sudo systemctl status nginx
```

### 4. 防火墙配置

```bash
# Ubuntu UFW
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw allow 22/tcp
sudo ufw enable

# CentOS firewalld
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --reload
```

---

## 🔒 SSL 证书配置（HTTPS）

### 方式1：使用 Let's Encrypt（免费）

```bash
# 安装 Certbot
sudo apt install -y certbot python3-certbot-nginx

# 获取证书（自动配置 Nginx）
sudo certbot --nginx -d your-domain.com -d www.your-domain.com

# 测试自动续期
sudo certbot renew --dry-run
```

### 方式2：使用自有证书

```bash
# 上传证书文件到服务器
sudo mkdir -p /etc/nginx/ssl
sudo cp your-certificate.crt /etc/nginx/ssl/
sudo cp your-private-key.key /etc/nginx/ssl/
```

修改 Nginx 配置添加 HTTPS：

```nginx
server {
    listen 443 ssl http2;
    server_name your-domain.com;

    ssl_certificate /etc/nginx/ssl/your-certificate.crt;
    ssl_certificate_key /etc/nginx/ssl/your-private-key.key;

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    # 其他配置同上...
}

# HTTP 重定向到 HTTPS
server {
    listen 80;
    server_name your-domain.com;
    return 301 https://$server_name$request_uri;
}
```

---

## 📊 PM2 进程管理

### 常用命令

```bash
# 查看所有进程
pm2 list

# 查看详细信息
pm2 show eduapp-server

# 查看实时日志
pm2 logs eduapp-server

# 重启应用
pm2 restart eduapp-server

# 停止应用
pm2 stop eduapp-server

# 删除应用
pm2 delete eduapp-server

# 重载应用（零停机时间）
pm2 reload eduapp-server

# 清除日志
pm2 flush
```

### PM2 配置文件（ecosystem.config.js）

创建配置文件以便更好地管理：

```bash
cd /var/www/eduapp/server
nano ecosystem.config.js
```

内容：

```javascript
module.exports = {
  apps: [{
    name: 'eduapp-server',
    script: './src/app.js',
    instances: 2,  // 多实例（集群模式）
    exec_mode: 'cluster',
    watch: false,
    max_memory_restart: '1G',
    env: {
      NODE_ENV: 'production',
      PORT: 3210
    },
    error_file: './logs/pm2-error.log',
    out_file: './logs/pm2-out.log',
    log_date_format: 'YYYY-MM-DD HH:mm:ss Z',
    merge_logs: true,
    autorestart: true,
    max_restarts: 10,
    min_uptime: '10s'
  }]
};
```

使用配置文件启动：

```bash
pm2 start ecosystem.config.js
pm2 save
```

---

## 🔄 更新部署

### 快速更新脚本

创建更新脚本：

```bash
nano /var/www/eduapp/deploy.sh
```

内容：

```bash
#!/bin/bash

echo "🚀 Starting deployment..."

# 进入项目目录
cd /var/www/eduapp

# 拉取最新代码
echo "📥 Pulling latest code..."
git pull origin main

# 更新后端
echo "🔧 Updating backend..."
cd server
npm install --production

# 更新前端
echo "🎨 Building frontend..."
cd ../client
npm install
npm run build

# 重启服务
echo "🔄 Restarting services..."
pm2 restart eduapp-server

echo "✅ Deployment completed!"
```

赋予执行权限：

```bash
chmod +x /var/www/eduapp/deploy.sh
```

执行更新：

```bash
cd /var/www/eduapp
./deploy.sh
```

---

## 📈 监控和维护

### 1. MongoDB 监控

```bash
# 查看 MongoDB 状态
sudo systemctl status mongod

# 连接到 MongoDB
mongosh

# 查看数据库
show dbs
use edu_app_prod
show collections

# 查看用户数
db.users.countDocuments()

# 退出
exit
```

### 2. 磁盘空间监控

```bash
# 查看磁盘使用情况
df -h

# 查看目录大小
du -sh /var/www/eduapp
du -sh /var/log/nginx
```

### 3. 日志管理

```bash
# 查看 Nginx 日志
sudo tail -f /var/log/nginx/eduapp-access.log
sudo tail -f /var/log/nginx/eduapp-error.log

# 查看 PM2 日志
pm2 logs eduapp-server --lines 100

# 清理旧日志
sudo find /var/log/nginx -name "*.log" -type f -mtime +30 -delete
```

### 4. 设置日志轮转

```bash
sudo nano /etc/logrotate.d/eduapp
```

内容：

```
/var/log/nginx/eduapp-*.log {
    daily
    missingok
    rotate 14
    compress
    delaycompress
    notifempty
    create 0640 www-data adm
    sharedscripts
    postrotate
        if [ -f /var/run/nginx.pid ]; then
            kill -USR1 `cat /var/run/nginx.pid`
        fi
    endscript
}
```

### 5. 系统监控

```bash
# 安装 htop（可选）
sudo apt install -y htop

# 查看系统资源
htop

# 查看 Node.js 进程
pm2 monit
```

---

## 🔐 安全加固

### 1. MongoDB 安全配置

```bash
# 连接到 MongoDB
mongosh

# 创建管理员用户
use admin
db.createUser({
  user: "admin",
  pwd: "strong-password-here",
  roles: [ { role: "userAdminAnyDatabase", db: "admin" } ]
})

# 创建应用用户
use edu_app_prod
db.createUser({
  user: "eduapp",
  pwd: "app-password-here",
  roles: [ { role: "readWrite", db: "edu_app_prod" } ]
})

exit
```

启用 MongoDB 认证：

```bash
sudo nano /etc/mongod.conf
```

添加/修改：

```yaml
security:
  authorization: enabled
```

重启 MongoDB：

```bash
sudo systemctl restart mongod
```

更新 `.env` 文件中的 MongoDB 连接字符串：

```env
MONGODB_URI=mongodb://eduapp:app-password-here@localhost:27017/edu_app_prod?authSource=edu_app_prod
```

### 2. 配置防火墙

```bash
# 只允许必要的端口
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw allow 22/tcp    # SSH
sudo ufw allow 80/tcp    # HTTP
sudo ufw allow 443/tcp   # HTTPS
sudo ufw enable

# 查看规则
sudo ufw status verbose
```

### 3. 禁用 root SSH 登录（可选但推荐）

```bash
sudo nano /etc/ssh/sshd_config
```

修改：

```
PermitRootLogin no
PasswordAuthentication no  # 强制使用 SSH 密钥
```

重启 SSH：

```bash
sudo systemctl restart sshd
```

---

## 🐛 常见问题

### Q1: 无法访问网站？

**排查步骤：**

1. 检查 Nginx 状态：
   ```bash
   sudo systemctl status nginx
   sudo nginx -t
   ```

2. 检查后端服务：
   ```bash
   pm2 status
   pm2 logs eduapp-server
   ```

3. 检查防火墙：
   ```bash
   sudo ufw status
   ```

4. 检查端口监听：
   ```bash
   sudo netstat -tuln | grep -E '80|443|3210'
   ```

### Q2: API 请求失败？

**检查：**

1. 后端服务是否运行
2. MongoDB 是否运行
3. 环境变量是否正确配置
4. Nginx 代理配置是否正确

```bash
# 测试后端 API
curl http://localhost:3210/api/health

# 查看后端日志
pm2 logs eduapp-server
```

### Q3: MongoDB 连接失败？

```bash
# 检查 MongoDB 状态
sudo systemctl status mongod

# 查看 MongoDB 日志
sudo tail -f /var/log/mongodb/mongod.log

# 重启 MongoDB
sudo systemctl restart mongod
```

### Q4: 内存不足？

```bash
# 查看内存使用
free -h

# 增加 swap 空间
sudo fallocate -l 2G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile
echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab

# 调整 PM2 实例数
pm2 scale eduapp-server 1
```

### Q5: 端口被占用？

```bash
# 查看端口占用
sudo lsof -i :3210
sudo lsof -i :80

# 杀死进程
sudo kill -9 <PID>
```

---

## 📝 备份策略

### 1. 数据库备份

创建备份脚本：

```bash
sudo nano /usr/local/bin/backup-mongodb.sh
```

内容：

```bash
#!/bin/bash

DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/var/backups/mongodb"
mkdir -p $BACKUP_DIR

mongodump --uri="mongodb://eduapp:password@localhost:27017/edu_app_prod" --out="$BACKUP_DIR/backup_$DATE"

# 保留最近7天的备份
find $BACKUP_DIR -type d -mtime +7 -exec rm -rf {} +

echo "Backup completed: $BACKUP_DIR/backup_$DATE"
```

设置定时任务：

```bash
sudo chmod +x /usr/local/bin/backup-mongodb.sh
sudo crontab -e
```

添加每天凌晨2点备份：

```cron
0 2 * * * /usr/local/bin/backup-mongodb.sh >> /var/log/mongodb-backup.log 2>&1
```

### 2. 代码备份

```bash
# 备份整个应用目录
tar -czf /var/backups/eduapp_$(date +%Y%m%d).tar.gz -C /var/www eduapp
```

---

## 🎯 性能优化

### 1. Nginx 缓存配置

在 Nginx 配置中添加：

```nginx
# 缓存配置
proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=api_cache:10m max_size=100m inactive=60m use_temp_path=off;

location /api {
    proxy_cache api_cache;
    proxy_cache_valid 200 5m;
    proxy_cache_bypass $http_cache_control;
    add_header X-Cache-Status $upstream_cache_status;
    # ... 其他配置
}
```

### 2. PM2 集群模式

```bash
# 使用多个 CPU 核心
pm2 start ecosystem.config.js
pm2 scale eduapp-server 4  # 4个实例
```

### 3. MongoDB 索引优化

```javascript
// 在 mongosh 中创建索引
use edu_app_prod

// 用户表索引
db.users.createIndex({ email: 1 }, { unique: true })
db.users.createIndex({ username: 1 }, { unique: true })

// 课程记录索引
db.records.createIndex({ userId: 1, courseId: 1 }, { unique: true })
db.records.createIndex({ userId: 1, lastAccessedAt: -1 })

// 对话记录索引
db.conversations.createIndex({ userId: 1, lastActiveAt: -1 })
```

---

## 📚 相关文档

- [README.md](../README.md) - 项目概述
- [开发计划.md](./开发计划.md) - 开发规划
- [快速开始.md](./快速开始.md) - 本地开发指南

---

## 📞 技术支持

如果在部署过程中遇到问题，请：

1. 查看日志文件
2. 参考常见问题部分
3. 联系 witdot Development Team

---

**文档版本**: v1.0.0
**最后更新**: 2025-10-29
**适用服务器**: 47.96.174.6 及其他 Linux 服务器
