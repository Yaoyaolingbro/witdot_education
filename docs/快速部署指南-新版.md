# 🚀 witdot Education AI Platform - 快速部署指南（更新版）

## 📋 部署前准备

### 1. 服务器要求
- **操作系统**: CentOS 7/8 或 RHEL 7/8
- **配置**: 最低 2核4GB，推荐 4核8GB
- **网络**: 需要公网 IP 地址
- **权限**: root 用户或具有 sudo 权限

### 2. 开放安全组端口

**重要**: 在运行部署脚本前，必须先开放以下端口：

#### 阿里云 ECS 安全组设置
1. 登录阿里云控制台
2. 进入 **云服务器 ECS** → **实例**
3. 选择你的服务器实例
4. 点击 **更多** → **网络和安全组** → **安全组配置**
5. 点击 **配置规则**
6. 添加以下入方向规则：

| 端口范围 | 授权对象 | 说明 |
|---------|---------|------|
| 80/80 | 0.0.0.0/0 | HTTP（必须） |
| 22/22 | 0.0.0.0/0 | SSH（已有） |

---

## 🎯 首次部署步骤

### 1. 连接到服务器
```bash
ssh root@47.96.174.6
```

### 2. 进入项目目录
```bash
cd /root/code/witdot_education   # 使用你的实际路径
```

### 3. 运行部署脚本
```bash
sudo ./deploy.sh
```

### 4. 按照提示操作

#### IP 地址选择
脚本会自动检测公网和内网 IP：
```
检测到的 IP 地址：
  内网IP: 172.26.43.219
  公网IP: 47.96.174.6

请选择要使用的 IP 地址 [1=公网IP, 2=内网IP, 3=手动输入] (默认: 1):
```
**推荐**: 直接按 Enter 使用公网 IP

#### 后端配置
- 后端服务端口：按 Enter（默认 3210）
- MongoDB 数据库名：按 Enter（默认 edu_app_prod）
- JWT Secret：按 Enter（自动生成）
- Claude API Key：**输入你的 API Key**（必填）

### 5. 等待完成

脚本会自动完成 9 个步骤（5-15分钟）：
1. ✅ 安装系统依赖（Node.js、MongoDB、Nginx、PM2）
2. ✅ 配置环境变量
3. ✅ 安装项目依赖
4. ✅ 构建前端
5. ✅ 初始化数据库
6. ✅ 配置 Nginx（含权限修复）
7. ✅ 启动后端服务
8. ✅ 配置防火墙
9. ✅ 完成！

---

## 🔄 更新部署（重要！）

当你修改了代码需要重新部署时，直接运行脚本即可：

### 快速更新
```bash
cd /root/code/witdot_education
sudo ./deploy.sh
```

脚本会自动检测已有部署，显示：
```
[WARNING] 检测到已存在的部署配置

请选择部署模式：
  1) 更新部署（保留配置，仅更新代码）
  2) 完全重新部署（重新配置所有内容）

请选择 [1/2] (默认: 1):
```

### 选项1：更新部署（推荐）⭐
直接按 Enter 或输入 `1`

**这个选项会**：
- ✅ 保留现有环境变量配置（API Key、数据库密码等）
- ✅ 重新安装/更新项目依赖
- ✅ 重新构建前端（应用代码更改）
- ✅ **自动修复目录权限问题**
- ✅ 更新 Nginx 配置
- ✅ 重启后端服务
- ⚡ 快速完成（只需 5 个步骤，约 2-3 分钟）

**适用场景**：
- 修改了前端/后端代码
- 添加了新功能
- 修复了 Bug
- 更新了依赖

### 选项2：完全重新部署
输入 `2`

**这个选项会**：
- ⚙️ 重新配置所有环境变量（需要重新输入）
- ⚙️ 完整的 9 步部署流程

**适用场景**：
- 需要更改 API Key
- 需要更改数据库配置
- 需要更改服务器 IP 配置
- 首次部署或完全重置

---

## 🔧 常见使用场景

### 场景1：修改了前端代码
```bash
# 更新代码后
cd /root/code/witdot_education
sudo ./deploy.sh
# 选择: 1（更新部署）
```

### 场景2：修改了后端代码
```bash
cd /root/code/witdot_education
sudo ./deploy.sh
# 选择: 1（更新部署）
```

### 场景3：出现权限错误（Permission denied）
```bash
# 运行更新部署，脚本会自动修复权限
cd /root/code/witdot_education
sudo ./deploy.sh
# 选择: 1（更新部署）
```

### 场景4：需要更换 API Key
```bash
# 方式1：直接编辑配置文件
nano /root/code/witdot_education/server/.env
# 修改 ANTHROPIC_API_KEY=新的key
pm2 restart eduapp-server

# 方式2：完全重新部署
sudo ./deploy.sh
# 选择: 2（完全重新部署）
```

---

## 🎉 访问应用

部署完成后，浏览器访问：**http://47.96.174.6**

---

## 📊 服务管理命令

### 查看服务状态
```bash
# 查看后端服务
pm2 status

# 查看 Nginx 状态
systemctl status nginx

# 查看 MongoDB 状态
systemctl status mongod
```

### 查看日志
```bash
# 后端实时日志
pm2 logs eduapp-server

# Nginx 访问日志
tail -f /var/log/nginx/eduapp-access.log

# Nginx 错误日志
tail -f /var/log/nginx/eduapp-error.log
```

### 重启服务（手动）
```bash
# 重启后端
pm2 restart eduapp-server

# 重启 Nginx
systemctl restart nginx

# 重启 MongoDB
systemctl restart mongod
```

---

## 🛠 故障排查

### 问题1: 无法访问网站

**检查命令**：
```bash
# 1. 检查后端是否运行
pm2 status

# 2. 检查 Nginx 是否运行
systemctl status nginx

# 3. 检查端口监听
netstat -tuln | grep -E ':80|:3210'

# 4. 测试本地访问
curl -I http://localhost:80
```

**常见原因**：
- ❌ 云服务器安全组未开放 80 端口 → 去控制台开放
- ❌ 系统防火墙阻止 → `firewall-cmd --permanent --add-service=http && firewall-cmd --reload`
- ❌ 服务未启动 → 运行 `sudo ./deploy.sh` 选择更新部署

### 问题2: 500 Internal Server Error

**检查步骤**：
```bash
# 1. 查看后端日志（最重要！）
pm2 logs eduapp-server --lines 50

# 2. 检查 MongoDB 是否运行
systemctl status mongod

# 3. 查看 Nginx 错误日志
tail -f /var/log/nginx/eduapp-error.log
```

**常见原因**：
- ❌ MongoDB 未启动 → `systemctl start mongod`
- ❌ 环境变量错误 → 检查 `/root/code/witdot_education/server/.env`
- ❌ API Key 无效 → 更新 `.env` 中的 `ANTHROPIC_API_KEY`

### 问题3: Permission Denied (权限错误)

**快速修复**：
```bash
# 运行更新部署（会自动修复权限）
cd /root/code/witdot_education
sudo ./deploy.sh
# 选择: 1（更新部署）
```

脚本会自动：
- 修复 `/root` 目录权限（755）
- 修复项目所有父目录权限
- 修复 `client/dist` 和 `server/public` 权限

---

## 📝 配置文件位置

| 文件 | 路径 | 说明 |
|------|------|------|
| 后端环境变量 | `项目路径/server/.env` | API Key、数据库连接等 |
| 前端环境变量 | `项目路径/client/.env.production` | API 地址配置 |
| Nginx 配置 | `/etc/nginx/conf.d/eduapp.conf` | Web 服务器配置 |
| PM2 进程列表 | `~/.pm2/dump.pm2` | 进程管理配置 |

---

## 🔐 安全建议

### 1. 定期备份数据库
```bash
# 备份 MongoDB 数据
mongodump --db edu_app_prod --out /backup/$(date +%Y%m%d)

# 压缩备份
tar -czf /backup/mongo_$(date +%Y%m%d).tar.gz /backup/$(date +%Y%m%d)
```

### 2. 配置 HTTPS（推荐）
```bash
# 需要域名才能使用
yum install -y certbot python3-certbot-nginx
certbot --nginx -d yourdomain.com
```

### 3. 监控日志
```bash
# 设置日志滚动（防止日志文件过大）
nano /etc/logrotate.d/eduapp
```

---

## 💡 高级技巧

### 手动更新（不使用脚本）

如果你只想快速更新前端：
```bash
cd /root/code/witdot_education/client
npm install
npm run build
systemctl restart nginx
```

如果你只想重启后端：
```bash
pm2 restart eduapp-server
```

### 查看环境配置
```bash
# 查看后端配置
cat /root/code/witdot_education/server/.env

# 查看前端配置
cat /root/code/witdot_education/client/.env.production

# 查看 Nginx 配置
cat /etc/nginx/conf.d/eduapp.conf
```

---

## 📞 获取帮助

### 文档资源
- [完整部署教程](./部署教程.md)
- [项目 README](../README.md)
- [开发计划](./开发计划.md)

### 快速参考
```bash
# 更新部署（最常用）
cd /root/code/witdot_education && sudo ./deploy.sh

# 查看后端日志
pm2 logs eduapp-server

# 查看服务状态
pm2 status && systemctl status nginx

# 重启所有服务
pm2 restart eduapp-server && systemctl restart nginx
```

---

**文档版本**: v2.0
**最后更新**: 2025-10-29
**适用系统**: CentOS 7/8, RHEL 7/8

**重要提示**: 每次运行 `./deploy.sh` 都会自动检测是首次部署还是更新部署，你只需要选择合适的选项即可！
